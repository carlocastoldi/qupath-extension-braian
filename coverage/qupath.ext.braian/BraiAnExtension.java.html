<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>BraiAnExtension.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">qupath-extension-braian</a> &gt; <a href="index.source.html" class="el_package">qupath.ext.braian</a> &gt; <span class="el_source">BraiAnExtension.java</span></div><h1>BraiAnExtension.java</h1><pre class="source lang-java linenums">// SPDX-FileCopyrightText: 2024 Carlo Castoldi &lt;carlo.castoldi@outlook.com&gt;
//
// SPDX-License-Identifier: AGPL-3.0-or-later

package qupath.ext.braian;

import org.controlsfx.control.action.Action;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import qupath.lib.gui.QuPathGUI;
import qupath.lib.gui.actions.ActionTools;
import qupath.lib.gui.extensions.QuPathExtension;
import qupath.lib.gui.tools.MenuTools;
import qupath.lib.objects.PathObject;
import qupath.lib.objects.hierarchy.PathObjectHierarchy;
import qupath.lib.scripting.QP;

import java.io.*;
import java.net.URLDecoder;
import java.nio.charset.StandardCharsets;
import java.util.*;
import java.util.jar.JarEntry;
import java.util.jar.JarFile;

<span class="nc" id="L25">public class BraiAnExtension implements QuPathExtension {</span>

    private static final String menuPosition = &quot;Extensions&gt;BraiAn&quot;;

<span class="nc" id="L29">    static final Logger logger = LoggerFactory.getLogger(BraiAnExtension.class);</span>

    /**
     * @return the logger used by the extension to print messages
     */
    public static Logger getLogger() {
<span class="nc" id="L35">        return logger;</span>
    }

    /**
     * integrate the extension in QuPath GUI
     * @param qupath the istance of QuPath to modify
     */
    @Override
    public void installExtension(QuPathGUI qupath) {
<span class="nc" id="L44">        this.addCommands(qupath);</span>
<span class="nc" id="L45">        this.addHelpScripts(qupath);</span>
<span class="nc" id="L46">    }</span>

    private void addCommands(QuPathGUI qupath) {
<span class="nc" id="L49">        var showExclusions = ActionTools.createAction(</span>
                () -&gt; {
<span class="nc" id="L51">                    PathObjectHierarchy hierarchy = QP.getCurrentHierarchy();</span>
<span class="nc bnc" id="L52" title="All 2 branches missed.">                    if (hierarchy == null) {</span>
<span class="nc" id="L53">                        logger.error(&quot;No image is currently open!&quot;);</span>
<span class="nc" id="L54">                        return;</span>
                    }
<span class="nc" id="L56">                    AtlasManager atlas = new AtlasManager(hierarchy);</span>
<span class="nc" id="L57">                    Set&lt;PathObject&gt; regionsToExcludeSet = atlas.getExcludedBrainRegions();</span>
<span class="nc" id="L58">                    QP.resetSelection();</span>
<span class="nc" id="L59">                    QP.selectObjects(regionsToExcludeSet);</span>
<span class="nc" id="L60">                },</span>
                &quot;Show regions currently excluded&quot;);
<span class="nc" id="L62">        MenuTools.addMenuItems(</span>
<span class="nc" id="L63">                qupath.getMenu(BraiAnExtension.menuPosition, true),</span>
                showExclusions
        );
<span class="nc" id="L66">    }</span>

    private void addHelpScripts(QuPathGUI qupath) {
<span class="nc" id="L69">        File extensionJar = getExtensionJarPath();</span>
<span class="nc bnc" id="L70" title="All 2 branches missed.">        if (extensionJar == null) {</span>
<span class="nc" id="L71">            logger.warn(&quot;Could not find the '{}' JAR file!&quot;, getClass().getSimpleName());</span>
<span class="nc" id="L72">            return;</span>
        }
<span class="nc bnc" id="L74" title="All 4 branches missed.">        String[] scripts = listJarDirectory(extensionJar, (dir, file) -&gt; dir.toString().equals(&quot;scripts&quot;) &amp;&amp; file.endsWith(&quot;.groovy&quot;));</span>

<span class="nc bnc" id="L76" title="All 2 branches missed.">        for(String scriptPath: scripts)</span>
<span class="nc" id="L77">            try (InputStream stream = getClass().getClassLoader().getResourceAsStream(scriptPath)) {</span>
<span class="nc bnc" id="L78" title="All 2 branches missed.">                assert stream != null;</span>
<span class="nc" id="L79">                String scriptName = new File(scriptPath).getName();</span>
<span class="nc" id="L80">                String script = new String(stream.readAllBytes(), StandardCharsets.UTF_8);</span>
<span class="nc" id="L81">                MenuTools.addMenuItems(</span>
<span class="nc" id="L82">                        qupath.getMenu(BraiAnExtension.menuPosition+&quot;&gt;Scripts&quot;, true),</span>
<span class="nc" id="L83">                        new Action(scriptName, e -&gt; openScript(qupath, scriptName, script))</span>
                );
<span class="nc" id="L85">            } catch (Exception e) {</span>
<span class="nc" id="L86">                logger.error(e.getLocalizedMessage(), e);</span>
<span class="nc" id="L87">            }</span>
<span class="nc" id="L88">    }</span>

    private File getExtensionJarPath() {
<span class="nc" id="L91">        File extensionJar = new File(getClass().getProtectionDomain().getCodeSource().getLocation().getPath());</span>
<span class="nc bnc" id="L92" title="All 2 branches missed.">        assert extensionJar.toString().endsWith(&quot;.jar&quot;);</span>
<span class="nc" id="L93">        return extensionJar;</span>
    }

    private String[] listJarDirectory(File jarPath, FilenameFilter filter) {
<span class="nc" id="L97">        Enumeration&lt;JarEntry&gt; internalFiles = null;</span>
<span class="nc" id="L98">        try (JarFile jar = new JarFile(URLDecoder.decode(jarPath.toString(), StandardCharsets.UTF_8))) {</span>
<span class="nc" id="L99">            internalFiles = jar.entries(); // gives ALL internalFiles in jar</span>
<span class="nc" id="L100">            List&lt;String&gt; selectedResources = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L101" title="All 2 branches missed.">            while(internalFiles.hasMoreElements()) {</span>
<span class="nc" id="L102">                String internalPath = internalFiles.nextElement().getName();</span>
<span class="nc bnc" id="L103" title="All 2 branches missed.">                if (internalPath.endsWith(&quot;/&quot;))</span>
<span class="nc" id="L104">                    continue;</span>
<span class="nc" id="L105">                File internalFilePath = new File(internalPath);</span>
<span class="nc bnc" id="L106" title="All 2 branches missed.">                if (filter.accept(internalFilePath.getParentFile(), internalFilePath.getName()))</span>
<span class="nc" id="L107">                    selectedResources.add(internalPath);</span>
<span class="nc" id="L108">            }</span>
<span class="nc" id="L109">            return selectedResources.toArray(new String[0]);</span>
<span class="nc" id="L110">        } catch (Exception e) {</span>
<span class="nc" id="L111">            logger.error(e.getLocalizedMessage(), e);</span>
<span class="nc" id="L112">            return new String[0];</span>
        }
    }

    private static void openScript(QuPathGUI qupath, String scriptName, String scriptCode) {
<span class="nc" id="L117">        var editor = qupath.getScriptEditor();</span>
<span class="nc bnc" id="L118" title="All 2 branches missed.">        if (editor == null) {</span>
<span class="nc" id="L119">            logger.error(&quot;No script editor is available!&quot;);</span>
<span class="nc" id="L120">            return;</span>
        }
<span class="nc" id="L122">        qupath.getScriptEditor().showScript(scriptName, scriptCode);</span>
<span class="nc" id="L123">    }</span>

    /**
     * @return the name of the extension
     */
    @Override
    public String getName() {
<span class="nc" id="L130">        return &quot;BraiAn extension&quot;;</span>
    }

    /**
     * @return the description of the extension
     */
    @Override
    public String getDescription() {
<span class="nc" id="L138">        return &quot;A collection of tools for whole-brain data quantification and extraction&quot;;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>